---
title: "Métodos experimentales en R"
author: "Irvin Rojas"
institute: "CIDE"
header-includes:
  - \usepackage{tikz}
  - \usetikzlibrary{shapes, shadows,arrows}
output:
  xaringan::moon_reader:
    css: [default, "libs/cide.css", metropolis-fonts, "https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap-grid.min.css", "https://use.fontawesome.com/releases/v5.7.2/css/all.css", "https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css"]
    seal: false
    chakra: "https://remarkjs.com/downloads/remark-latest.min.js"
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      titleSlideClass: ["middle", "center"]
      ratio: "16:9"
      beforeInit: ["https://platform.twitter.com/widgets.js", "libs/cols_macro.js"]
      navigation:
        scroll: false


---
class: title-slide

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path = "figures/")

library(tidyverse)
library(janitor)
library(sandwich)
library(clubSandwich)
library(modelsummary)

xfun::pkg_load2(c('base64enc', 'htmltools', 'mime'))
```

```{css, echo = FALSE}
.huge .remark-code { /*Change made here*/
  font-size: 200% !important;
}
.tiny .remark-code { /*Change made here*/
  font-size: 60% !important;
}
```

.title[
# Métodos experimentales en R
]
.subtitle[
## Evaluación de Programas
]
.author[
### Irvin Rojas <br> [rojasirvin.com](https://www.rojasirvin.com/) <br> [<i class="fab fa-github"></i>](https://github.com/rojasirvin) [<i class="fab fa-twitter"></i>](https://twitter.com/RojasIrvin) [<i class="ai ai-google-scholar"></i>](https://scholar.google.com/citations?user=FUwdSTMAAAAJ&hl=en)
]

.affiliation[
### Centro de Investigación y Docencia Económicas <br> División de Economía
]

---
# Agenda

1. Breve recordatorio de estructura de bases

1. Estadística descriptiva y pruebas de hipótesis
---

class: inverse, middle, center

# Estructura de bases usando la ENOE

---

class: inverse, middle, center

# Pruebas de balance usando regresión

---

# Datos de Angrist

- Noten que aquí solo analizaremos UN tratamiento


- Los números que generemos no serán iguales a los reportados en el artículo

```{r echo=TRUE, warning=FALSE, message=FALSE}

data.angrist<-read_csv("./STAR_public_use.csv",
                       locale = locale(encoding = "latin1"))   %>% 
  clean_names()


#Usemos por ahora un solo tratamiento, SSP
data.angrist.table1<-data.angrist %>% 
  select(noshow,age,female, mtongue, gpa0, ssp) %>%
  mutate(mtongue=ifelse(mtongue=="English",1,0)) %>% 
  mutate(ssp=factor(ssp,levels=c(0,1),
             labels=c("Control","SSP")))



```

---

# Estadística descriptiva

```{r echo=TRUE, warning=FALSE}
#Pedimos estadísticas por grupo
data.angrist.table1 %>% 
  filter(noshow==0) %>% 
  group_by(ssp) %>% 
  summarize(mean=mean(age),
            std=sd(age), n=n()) %>% 
  ungroup()
```

---

# Diferencias de medias

- Con *prueba t*

```{r echo=TRUE, warning=FALSE, message=FALSE}
t.test(data=filter(data.angrist.table1,noshow==0),
       age ~ ssp)
```

---

# Diferencias de medias

- Con una regresión
```{r echo=TRUE, warning=FALSE, message=FALSE}
dif_age <- lm(age ~ ssp,
              data=filter(data.angrist.table1,noshow==0))
summary(dif_age)$coef
```


---

# ¿Los observables predicen el tratamiento?

```{r echo=TRUE, warning=FALSE, message=FALSE}
predict_t <- lm(as.numeric(ssp) ~ age + female + mtongue + gpa0,
                data=filter(data.angrist.table1,noshow==0) )
summary(predict_t)$coef
```
---

class: inverse, middle, center

# Un paréntesis: *modelsummary*
---

# Un paréntesis

.pull-left[
- El paquete *modelsummary* puede serles útil para construir tablas

- Para hacer estadística descriptiva:

```{r echo=TRUE, warning=FALSE, message=FALSE}
tabla.descriptiva <- datasummary(noshow+age+female~ ssp*(mean + sd)*Arguments(na.rm=TRUE),
                    fmt = "%.2f",
                    data = data.angrist.table1,
                    title = "Pruebas de balance",
                    notes = "Fuente: Angrist, Lang & Oreopoulos (2009)")
```
]
.pull-right[
```{r echo=TRUE, warning=FALSE, message=FALSE}
tabla.descriptiva
```
]

---

# Un paréntesis

.pull-left[
- Para hacer tablas de balance:
```{r echo=TRUE,warning=FALSE, message=FALSE}
tabla.balance <- datasummary_balance(~ssp,
                    fmt = "%.2f",
                    data = data.angrist.table1,
                    title = "Pruebas de balance",
                    notes = "Fuente: Angrist, Lang & Oreopoulos (2009)")

```
]

.pull-right[
```{r echo=TRUE,warning=FALSE, message=FALSE}
tabla.balance
```
]

---

class: inverse, middle, center

# Cumplimiento imperfecto

---

# Cumplimiento imperfecto

- Crépon, Devoto, Duflo & Parienté (2015), Estimating the Impact of Microcredit on Those Who Take It Up

- Experimento en Marruecos

--

- Pareciera que las intervenciones de microfinanzas no tienen efectos en el hogar promedio

- Los autores estudian con detalle el efecto de la adopción

- En 81 de 162 localidades se **introdujo** aleatoriamente una empresa de microfinanzas

- Para seleccionar las localidades de tratamiento, primer se emparejaron localidades de acuerdo a características observables y, para cada pareja se asignó a tratamiento y otra a control


--

- Tenemos entonces dos indicadores

  - **treatment** es la variable de asignación aleatoria
  
  - **client** es la variable de adopción

---

# Cumplimiento imperfecto

```{r echo=TRUE,warning=FALSE, message=FALSE}
data.morocco<-read_csv("./crepon_morocco.csv",
                       locale = locale(encoding = "latin1"))   %>% 
  clean_names() %>% 
  filter(merge_indicator!=1)   # 2 y 3 incluyen la línea base
```

- Veamos la estadística descriptiva básica de la variable de tamaño del hogar:

```{r echo=TRUE,warning=FALSE, message=FALSE}
data.morocco %>% 
  group_by(treatment) %>%
  summarize(mean=mean(members_resid_bl),
            std=sd(members_resid_bl), n=n()) %>% 
  ungroup()
```

---

# Prueba de balance con regresión

```{r echo=TRUE,warning=FALSE, message=FALSE}
#Con una regresión:
dif_members <- lm(members_resid_bl ~ treatment + factor(paire), data=data.morocco)
summary(dif_members)$coef[1:7,]
```

---

# Errores estándar *agrupados*

```{r echo=TRUE,warning=FALSE, message=FALSE}
#Usemos errores estándar agrupados
#Esto es lo más cercano que he llegado de lo que producen los autores
coef_test(dif_members, vcov = "CR1", 
          cluster = data.morocco$demi_paire, test = "naive-t")[1:2,]

```

---

# Hay selección

```{r echo=TRUE,warning=FALSE, message=FALSE}
##Pero hay selección, veamos un tabulado cruzado
data.morocco %>%
  mutate(treatment=factor(treatment, levels=c(0,1),labels=c("Control", "Tratamiento"))) %>% 
  mutate(client=factor(client, levels=c(0,1),labels=c("No cliente", "Cliente"))) %>% 
  tabyl(treatment, client)

```
---

# Ser cliente no es independiente

```{r echo=TRUE,warning=FALSE, message=FALSE}
#¿Ser cliente es independiente del tamaño del hogar?
dif_members_client <- lm(members_resid_bl ~ client + factor(paire), data=data.morocco)
coef_test(dif_members_client, vcov = "CR1", 
          cluster = data.morocco$demi_paire, test = "naive-t")[1:2,]
```

--

```{r echo=TRUE,warning=FALSE, message=FALSE}
#¿El número de actividades es independiente de ser cliente?
dif_activities_client <- lm(act_number_bl ~ client + factor(paire), data=data.morocco)
coef_test(dif_activities_client, vcov = "CR1", 
          cluster = data.morocco$demi_paire, test = "naive-t")[1:2,]

```
---

class: center, middle

Presentación creada usando el paquete [**xaringan**](https://github.com/yihui/xaringan) en R.

El *chakra* viene de [remark.js](https://remarkjs.com), [**knitr**](http://yihui.org/knitr), y [R Markdown](https://rmarkdown.rstudio.com).

Material de clase en versión preliminar.

**No reproducir, no distribuir, no citar.**


